<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>team</title>
  <meta name="theme-color" content="#0d0d0d">
  <link rel="icon" href="/images/favicon.png" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.4.0/fonts/remixicon.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/css/dashboard.css">
  <link rel="stylesheet" href="/css/profile.css">
  <link rel="stylesheet" href="/css/shop.css">
  <link rel="stylesheet" href="/css/team.css">
</head>

<body>

  <!-- ALL ABOUT LARGE SCREENS -->
  <%- include ('partials/big-screen') %>



    <div class="hold">
      <!-- NAVBAR  -->
      <%- include ('partials/nav') %>

        <!-- Header -->
        <div class="header">
          <div class="brand-text">
            <h1>Team Report</h1>
          </div>
          <div class="settings-icon" id="settingsBtn">
            <i class="ri-notification-2-line"></i>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
          <div class="noti-icon" id="closeBtn">
            <i class="ri-close-line"></i>
          </div>

          <div class="notification-details">
            <!-- HISTORY -->
            <div class="section-title" style="margin-top: 18px;">
              <h2>Claim History</h2>
              <span class="badge">Audit trail â€¢ Money intact ðŸ”’</span>
            </div>

            <div class="history-container">
              <% if (withdrawals.length===0) { %>
                <p class="empty">No claims yet.</p>
                <% } else { %>
                  <ul class="history-list">
                    <% withdrawals.forEach(w=> { %>
                      <li class="history-item <%= w.type %> <%= w.status %>">
                        <div>
                          <strong>
                            <%= w.type.charAt(0).toUpperCase() + w.type.slice(1) %> withdrawal
                          </strong><br>
                          â‚¦<%= w.amount.toLocaleString() %>
                        </div>
                        <span class="status <%= w.status %>">
                          <%= w.status.charAt(0).toUpperCase() + w.status.slice(1) %>
                        </span>
                      </li>
                      <% }) %>
                  </ul>
                  <% } %>
            </div>

          </div>


        </div>





        <div class="container">

          <!-- FERERAL SECTION  -->
          <div class="invitation-section">
            <div class="invitation-header">Invitation Code</div>

            <div class="referal-hold">
              <div class="invitation-code">
                <% if (!referralUnlocked) { %>
                  <span class="invitation-url">************************</span>
                  <span class="invitation-number">*****</span>
                  <% } else { %>
                    <span class="invitation-url">https://dynamiqerra.com/</span>
                    <!-- <span class="invitation-url">http://localhost:3000/</span> -->
                    <span class="invitation-number">
                      <%= user.referral %>
                    </span>
                    <% } %>
              </div>

              <button class="copy-btn" data-referral="<%= user.referral %>" data-active="<%= !!referralUnlocked %>"
                onclick="copyReferral(this.dataset.referral, this.dataset.active === 'true')">
                Copy
              </button>
            </div>
          </div>


          <!-- Referal stats  -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number">
                <%= totalReferralsCount %>
              </div>
              <div class="stat-label">Total Referrals</div>
            </div>

            <div class="stat-card">
              <div class="stat-number">
                <%= verifiedReferralsCount %>
              </div>
              <div class="stat-label">Verified Referrals</div>
            </div>

            <div class="stat-card">
              <div class="stat-number">â‚¦<%= referralAmount.toLocaleString() %>
              </div>
              <div class="stat-label">Referral Amount</div>
            </div>

            <div class="stat-card">
              <div class="stat-number <%= bankSubmitted ? 'submitted' : 'awaiting' %>">
                <%= bankSubmitted ? 'Submitted' : 'Awaiting' %>
              </div>
              <div class="stat-label">My bank details</div>
            </div>

          </div>






          <!--REFERAL BONUS-->
          <div class="section-title">
            <h2>Referral Bonus</h2>
            <span class="badge">Withdrawable Monâ€“Sat</span>
          </div>

          <div class="grid">
            <div class="card col-6">
              <h3>Your Referral Bonus Balance</h3>
              <div class="stat">
                â‚¦<%= referralAmount.toLocaleString() %>
              </div>
              <div class="sub">
                Min withdrawal <strong>â‚¦1,000</strong>
              </div>
              <div class="btn-hold">
                <button class="btn btn-bonus withdraw-btn" data-type="referral">Withdraw</button>
                <span class="note">Withdrawals are available Monday to Saturday. Referal Balance resets after admin
                  approval.</span>
              </div>
            </div>
          </div>






          <!-- WEEKLY SALARY -->
          <div class="section-title">
            <h2>Weekly Salary</h2>
            <span class="badge">Withdrawable only on Saturdays</span>
          </div>

          <div class="grid">
            <div class="card col-6">
              <h3>Your Weekly Eligibility</h3>
              <p class="sub">Verified referrals counted in a week (reset after admin approval or every Saturday)</p>
              <div class="stat">
                <%= weeklyReferralsCount %>
              </div>
              <div class="sub">
                Eligible Tier:
                <strong id="weekly-tier-label"></strong> â†’
                <strong id="weekly-bonus-label"></strong>
              </div>
              <div class="btn-hold">
                <button class="btn btn-success withdraw-btn" data-type="weekly">Withdraw</button>
                <span class="note">Withdrawals are available only on Saturdays. Referrals reset weekly, even if no tier
                  met.</span>
              </div>
            </div>

            <div class="card col-6">
              <h3>Weekly Tiers</h3>
              <table aria-label="Weekly Tiers">
                <thead>
                  <tr>
                    <th>Verified Referrals</th>
                    <th>Bonus</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Min â€“ 10</td>
                    <td>â‚¦5,000</td>
                  </tr>
                  <tr>
                    <td>11 â€“ 20</td>
                    <td>â‚¦10,000</td>
                  </tr>
                  <tr>
                    <td>21 â€“ 50</td>
                    <td>â‚¦20,000</td>
                  </tr>
                  <tr>
                    <td>50 â€“ 100</td>
                    <td>â‚¦100,000</td>
                  </tr>
                  <tr>
                    <td>100 â€“ 300</td>
                    <td>â‚¦200,000</td>
                  </tr>
                  <tr>
                    <td>300+</td>
                    <td>â‚¦250,000</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>







          <!-- MONTHLY SALARY -->
          <div class="section-title" style="margin-top: 18px;">
            <h2>Monthly Salary</h2>
            <span class="badge">Last Saturday of the month</span>
          </div>

          <div class="grid">
            <div class="card col-6">
              <h3>Your Monthly Eligibility</h3>
              <p class="sub">Verified referrals counted in a month (reset after admin approval or end of month)</p>
              <div class="stat">
                <%= monthlyReferralsCount %>
              </div>
              <div class="sub">
                Eligible Tier:
                <strong id="monthly-tier-label"></strong> â†’
                <strong id="monthly-salary-label"></strong>
              </div>
              <div class="btn-hold">
                <button class="btn btn-accent withdraw-btn" data-type="monthly">Withdraw</button>
                <span class="note">Withdrawals are available only on the last Saturday of the month. Referrals reset
                  monthly, even if no tier met.</span>
              </div>
            </div>

            <div class="card col-6">
              <h3>Monthly Tiers</h3>
              <table aria-label="Monthly Tiers">
                <thead>
                  <tr>
                    <th>Verified Referrals</th>
                    <th>Salary</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>20 â€“ 50</td>
                    <td>â‚¦10,000</td>
                  </tr>
                  <tr>
                    <td>50 â€“ 100</td>
                    <td>â‚¦25,000</td>
                  </tr>
                  <tr>
                    <td>100 â€“ 200</td>
                    <td>â‚¦50,000</td>
                  </tr>
                  <tr>
                    <td>200 â€“ 500</td>
                    <td>â‚¦150,000</td>
                  </tr>
                  <tr>
                    <td>500+</td>
                    <td>â‚¦300,000</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>




          <div class="card col-12">
            <p class="note">
              Note: <em>Referal bonus</em> consume the referal amount once marked as paid by admin. <em>Weekly</em>
              claims consume verified referrals for that week after admin marks as Paid. <em>Monthly</em> salary counts
              all verified referrals in the month, even those already used weekly claims.
            </p>
          </div>
        </div>


    </div>


    <!-- Hidden data for script -->
    <div id="team-data" data-verified-referrals="<%= verifiedReferralsCount %>"
      data-bank-submitted="<%= bankSubmitted %>" hidden></div>

    <!-- SCRIPTS -->

    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
      // Copy referral
      function copyReferral(code, isActive) {
        if (!isActive) {
          Toastify({
            text: "Buy a store to unlock ref link",
            duration: 3000,
            gravity: "top",
            position: "center",
            backgroundColor: "#e74c3c"
          }).showToast();
          return;
        }
        // const link = `http://localhost:3000/${code}`;
        const link = `https://dynamiqerra.com/${code}`;
        navigator.clipboard.writeText(link);
        Toastify({
          text: "Referral link copied",
          duration: 3000,
          gravity: "top",
          position: "center",
          backgroundColor: "#2ecc71"
        }).showToast();
      }

      // Withdrawal buttons
      const teamDataEl = document.getElementById('team-data');
      const verifiedReferrals = Number(teamDataEl.dataset.verifiedReferrals || 0);
      const bankSubmitted = teamDataEl.dataset.bankSubmitted === 'true';
      const referralAmount = Number("<%= referralAmount %>");
      const weeklyReferralsCount = Number("<%= weeklyReferralsCount %>");
      const monthlyReferralsCount = Number("<%= monthlyReferralsCount %>");

      // Weekly tiers
      const weeklyTiers = [
        { min: 10, label: 'Min â€“ 10', bonus: 5000 },
        { min: 11, label: '11 â€“ 20', bonus: 10000 },
        { min: 21, label: '21 â€“ 50', bonus: 20000 },
        { min: 50, label: '50 â€“ 100', bonus: 100000 },
        { min: 100, label: '100 â€“ 300', bonus: 200000 },
        { min: 300, label: '300+', bonus: 250000 }
      ];

      function getWeeklyTier(referrals) {
        for (let i = weeklyTiers.length - 1; i >= 0; i--) {
          if (referrals >= weeklyTiers[i].min) {
            return weeklyTiers[i];
          }
        }
        return null;
      }

      // Monthly tiers
      const monthlyTiers = [
        { min: 20, label: '20 â€“ 50', salary: 10000 },
        { min: 50, label: '50 â€“ 100', salary: 25000 },
        { min: 100, label: '100 â€“ 200', salary: 50000 },
        { min: 200, label: '200 â€“ 500', salary: 150000 },
        { min: 500, label: '500+', salary: 300000 }
      ];

      function getMonthlyTier(referrals) {
        for (let i = monthlyTiers.length - 1; i >= 0; i--) {
          if (referrals >= monthlyTiers[i].min) {
            return monthlyTiers[i];
          }
        }
        return null;
      }

      // Show eligible tier in UI
      const weeklyTier = getWeeklyTier(weeklyReferralsCount);
      document.getElementById('weekly-tier-label').textContent = weeklyTier ? weeklyTier.label : 'None';
      document.getElementById('weekly-bonus-label').textContent = weeklyTier ? `â‚¦${weeklyTier.bonus.toLocaleString()}` : 'â‚¦0';

      const monthlyTier = getMonthlyTier(monthlyReferralsCount);
      document.getElementById('monthly-tier-label').textContent = monthlyTier ? monthlyTier.label : 'None';
      document.getElementById('monthly-salary-label').textContent = monthlyTier ? `â‚¦${monthlyTier.salary.toLocaleString()}` : 'â‚¦0';

      document.querySelectorAll(".withdraw-btn").forEach(btn => {
        btn.addEventListener("click", async function () {
          const type = this.dataset.type;
          let eligible = false;
          const today = new Date();

          // âœ… 1. Check bank details first
          if (!bankSubmitted) {
            Toastify({
              text: "Bank details not submitted",
              duration: 3000,
              gravity: "top",
              position: "center",
              backgroundColor: "#e74c3c"
            }).showToast();
            return;
          }

          // âœ… Referral Bonus withdrawal rules
          if (type === "referral") {
            if (referralAmount < 1000) {
              Toastify({
                text: "Minimum withdrawal is â‚¦1,000",
                duration: 3000,
                gravity: "top",
                position: "center",
                backgroundColor: "#e74c3c"
              }).showToast();
              return;
            }
            if (today.getDay() === 0) {
              Toastify({
                text: "Withdrawals are not allowed on Sundays.",
                duration: 3000,
                gravity: "top",
                position: "center",
                backgroundColor: "#e74c3c"
              }).showToast();
              return;
            }
            eligible = true;
          }

          // âœ… Weekly withdrawal rules
          if (type === "weekly") {
            const tier = getWeeklyTier(weeklyReferralsCount);
            if (!tier) {
              Toastify({
                text: "Not enough weekly referrals for any tier",
                duration: 3000,
                gravity: "top",
                position: "center",
                backgroundColor: "#e74c3c"
              }).showToast();
              return;
            }
            // Saturday only
            if (today.getDay() !== 6) {
              Toastify({
                text: "Only allowed on Saturdays.",
                duration: 3000,
                gravity: "top",
                position: "center",
                backgroundColor: "#e74c3c"
              }).showToast();
              return;
            }
            eligible = true;
          }

          // âœ… Monthly withdrawal rules
          if (type === "monthly") {
            const tier = getMonthlyTier(monthlyReferralsCount);
            if (!tier) {
              Toastify({
                text: "Not enough monthly referrals for any tier",
                duration: 3000,
                gravity: "top",
                position: "center",
                backgroundColor: "#e74c3c"
              }).showToast();
              return;
            }
            // Last Saturday of the month only
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            const lastSaturday = new Date(lastDay);
            lastSaturday.setDate(lastDay.getDate() - ((lastDay.getDay() + 1) % 7));
            if (!(today.getDay() === 6 && today.getDate() === lastSaturday.getDate())) {
              Toastify({
                text: "Allowed on the last Saturday of the month.",
                duration: 3000,
                gravity: "top",
                position: "center",
                backgroundColor: "#e74c3c"
              }).showToast();
              return;
            }
            eligible = true;
          }

          // âœ… If passed all checks â†’ submit and show response from server
          if (eligible) {
            const res = await fetch("/team/withdraw", {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                type
              })
            });

            const data = await res.json();

            if (data.success) {
              Toastify({
                text: "Withdrawal submitted successfully",
                duration: 4000,
                gravity: "top",
                position: "center",
                backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)"
              }).showToast();

              // refresh page so user sees updated stats/history
              setTimeout(() => window.location.reload(), 1000);

            } else {
              Toastify({
                text: data.message || "Withdrawal failed",
                duration: 4000,
                gravity: "top",
                position: "center",
                backgroundColor: "#e74c3c"
              }).showToast();
            }
          }

        });
      });
    </script>



    <!-- // Disable withdraw buttons on first click to prevent double submit -->
    <!-- <script>
          document.querySelectorAll(".withdraw-btn").forEach(btn => {
            btn.addEventListener("click", function () {
              // only disable if not already disabled
              if (!this.disabled) {
                this.disabled = true;
                this.dataset.originalText = this.innerText;
                this.innerText = "Processing...";
              }
            });
          });
        </script> -->




    <%# FUCTION FOR SLIDE %>
      <script>
        const settingsBtn = document.getElementById('settingsBtn');
        const sidebar = document.getElementById('sidebar');
        const closeBtn = document.getElementById('closeBtn');

        settingsBtn.addEventListener('click', () => {
          sidebar.classList.add('active');
        });

        closeBtn.addEventListener('click', () => {
          sidebar.classList.remove('active');
        });
      </script>


</body>

</html>